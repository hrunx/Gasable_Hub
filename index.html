<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gasable Hub - Chat</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container wide">
    <h1>Gasable Hub</h1>
    <div class="topbar">
      <a href="/dashboard.html">Open Dashboard â†’</a>
    </div>
    <div class="layout">
      <div class="left">
        <form id="chat-form">
          <input id="q" type="text" placeholder="Ask something..." autocomplete="off" />
          <button type="submit">Send</button>
        </form>
        <div id="output"></div>
      </div>
      <div class="right">
        <div class="card">
          <div class="section-title">Process</div>
          <div id="stream" class="stream"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
  const form = document.getElementById('chat-form');
  const q = document.getElementById('q');
  const out = document.getElementById('output');
  const stream = document.getElementById('stream');

  function appendStream(line, kind='info') {
    const div = document.createElement('div');
    div.className = `line ${kind}`;
    div.textContent = line;
    stream.appendChild(div);
    stream.scrollTop = stream.scrollHeight;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const query = q.value.trim();
    if (!query) return;
    out.innerHTML += `<div class="user">${query}</div>`;
    q.value = '';

    // Single-shot on Netlify; keep streaming for local FastAPI
    stream.innerHTML = '';
    appendStream('Starting...', 'start');
    const isNetlify = location.hostname.endsWith('netlify.app');
    if (isNetlify) {
      // Use direct SSE function in production
      const ssePath = '/.netlify/functions/query_stream';
      const es = new EventSource(`${ssePath}?q=${encodeURIComponent(query)}`);
      es.addEventListener('step', (evt) => {
        try {
          const data = JSON.parse(evt.data);
          const label = data.step || 'step';
          const info = Object.entries(data).filter(([k]) => k !== 'step').map(([k,v]) => `${k}=${typeof v==='object'?JSON.stringify(v):v}`).join(' ');
          appendStream(`${label} ${info}`);
        } catch {}
      });
      es.addEventListener('final', (evt) => {
        try {
          const data = JSON.parse(evt.data);
          if (data.error) {
            appendStream(`error ${data.error}`, 'error');
            out.innerHTML += `<div class="bot">${data.error}</div>`;
          } else {
            const html = String(data.answer_html || (data.answer||'').replace(/\n/g,'<br>'));
            out.innerHTML += `<div class="bot">${html}</div>`;
          }
        } catch (e) {
          out.innerHTML += `<div class="bot">${String(e)}</div>`;
        } finally {
          es.close();
          out.scrollTop = out.scrollHeight;
        }
      });
      es.onerror = () => { appendStream('stream error', 'error'); es.close(); };
    } else {
      // Local FastAPI streaming SSE
      const ssePath = '/api/query_stream';
      const es = new EventSource(`${ssePath}?q=${encodeURIComponent(query)}`);
      es.addEventListener('step', (evt) => {
        try {
          const data = JSON.parse(evt.data);
          const label = data.step || 'step';
          const info = Object.entries(data).filter(([k]) => k !== 'step').map(([k,v]) => `${k}=${typeof v==='object'?JSON.stringify(v):v}`).join(' ');
          appendStream(`${label} ${info}`);
        } catch {}
      });
      es.addEventListener('final', (evt) => {
        try {
          const data = JSON.parse(evt.data);
          if (data.error) {
            appendStream(`error ${data.error}`, 'error');
            out.innerHTML += `<div class=\"bot\">${data.error}</div>`;
          } else {
            const html = String(data.answer_html || (data.answer||'').replace(/\n/g,'<br>'));
            out.innerHTML += `<div class=\"bot\">${html}</div>`;
          }
        } catch (e) {
          out.innerHTML += `<div class=\"bot\">${String(e)}</div>`;
        } finally {
          es.close();
          out.scrollTop = out.scrollHeight;
        }
      });
      es.onerror = () => { appendStream('stream error', 'error'); es.close(); };
    }
  });
  </script>
  <style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #0b0f1a; color: #e8eef9; }
  .container.wide { max-width: 1400px; margin: 24px auto; padding: 24px; background: #111827; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
  h1 { margin: 0 0 16px; font-size: 22px; letter-spacing: 0.5px; }
  .topbar a { color: #93c5fd; text-decoration: none; }
  .layout { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; align-items: start; }
  form { display: flex; gap: 8px; margin-bottom: 16px; }
  input { flex: 1; padding: 12px 14px; border-radius: 10px; border: 1px solid #2b3446; background: #0f172a; color: #e8eef9; }
  button { padding: 12px 16px; border: none; border-radius: 10px; background: #2563eb; color: white; cursor: pointer; }
  #output { height: 70vh; overflow: auto; display: flex; flex-direction: column; gap: 10px; }
  .user { align-self: flex-end; background: #1f2937; padding: 10px 12px; border-radius: 10px; max-width: 100%; }
  .bot { align-self: flex-start; background: #0b2239; padding: 10px 12px; border-radius: 10px; max-width: 100%; }
  .card { background: #0b2239; border: 1px solid #2b3446; border-radius: 10px; padding: 10px; }
  .section-title { font-weight: 600; margin-bottom: 8px; }
  .stream { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; height: 70vh; overflow: auto; background: #09182c; padding: 8px; border-radius: 8px; }
  .line { padding: 2px 0; color: #cfe0ff; }
  .line.start { color: #93c5fd; }
  .line.error { color: #ff6b6b; }
  .left { min-width: 0; }
  .right { min-width: 0; }
  </style>
</body>
</html>


